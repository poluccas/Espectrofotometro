import streamlit as st
import numpy as np
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import pandas as pd
from datetime import datetime

# Configura√ß√£o da p√°gina
st.set_page_config(page_title="Espectr√¥metro Vegetal", layout="wide")

# T√≠tulo e descri√ß√£o
st.title("üåø Espectr√¥metro para An√°lise Vegetal")
st.markdown("---")

# Inicializar estado da sess√£o para controle da captura
if 'freeze_data' not in st.session_state:
    st.session_state.freeze_data = False
if 'frozen_spectrum' not in st.session_state:
    st.session_state.frozen_spectrum = None
if 'frozen_intensities' not in st.session_state:
    st.session_state.frozen_intensities = None
if 'frozen_ppfd' not in st.session_state:
    st.session_state.frozen_ppfd = None

# Barra lateral para controles
with st.sidebar:
    st.header("‚öôÔ∏è Configura√ß√µes")
    
    # Sliders para intensidades simuladas
    st.subheader("Controles de Intensidade")
    intensidade_vermelho = st.slider("Intensidade Vermelho (660 nm)", 0.0, 1.0, 0.8, 0.01)
    intensidade_azul = st.slider("Intensidade Azul (450 nm)", 0.0, 1.0, 0.6, 0.01)
    intensidade_verde = st.slider("Intensidade Verde (550 nm)", 0.0, 1.0, 0.3, 0.01)
    intensidade_ir = st.slider("Intensidade Infravermelho (730 nm)", 0.0, 1.0, 0.4, 0.01)
    
    # Controle de ru√≠do
    ruido = st.slider("N√≠vel de Ru√≠do", 0.0, 0.2, 0.05, 0.01)
    
    # Bot√£o para capturar espectro
    st.markdown("---")
    if st.button("üì∏ Capturar Espectro" if not st.session_state.freeze_data else "‚ñ∂Ô∏è Continuar Atualiza√ß√£o"):
        st.session_state.freeze_data = not st.session_state.freeze_data
        if st.session_state.freeze_data:
            st.rerun()
    
    # Informa√ß√µes adicionais
    st.markdown("---")
    st.info("""
    **Instru√ß√µes:**
    1. Ajuste as intensidades
    2. Clique em 'Capturar Espectro' para congelar
    3. Clique novamente para continuar
    """)

# Fun√ß√£o para gerar dados espectrais simulados
def gerar_espectro_simulado():
    # Comprimentos de onda de 380 a 800 nm
    wavelength = np.linspace(380, 800, 421)
    
    # Gerar picos espectrais
    spectrum = np.zeros_like(wavelength)
    
    # Adicionar picos nas regi√µes espec√≠ficas
    picos = [
        (450, intensidade_azul, 15),      # Azul
        (550, intensidade_verde, 20),     # Verde  
        (660, intensidade_vermelho, 15),  # Vermelho
        (730, intensidade_ir, 25),        # Infravermelho pr√≥ximo
    ]
    
    for center, intensity, width in picos:
        spectrum += intensity * np.exp(-((wavelength - center) / width) ** 2)
    
    # Adicionar ru√≠do
    spectrum += np.random.normal(0, ruido, spectrum.shape)
    
    # Garantir valores n√£o negativos
    spectrum = np.maximum(spectrum, 0)
    
    return wavelength, spectrum

# Fun√ß√£o para calcular PPFD
def calcular_ppfd(wavelength, spectrum):
    """
    Calcula PPFD (Photosynthetic Photon Flux Density) em ¬µmol/m¬≤/s
    Considerando apenas o espectro fotossinteticamente ativo (400-700 nm)
    """
    # Filtrar para PAR (400-700 nm)
    mask = (wavelength >= 400) & (wavelength <= 700)
    par_wavelength = wavelength[mask]
    par_spectrum = spectrum[mask]
    
    if len(par_wavelength) == 0:
        return 0.0
    
    # Converter intensidade relativa para PPFD (simula√ß√£o simplificada)
    # Em um sistema real, isso exigiria calibra√ß√£o com sensor de refer√™ncia
    area_under_curve = np.trapz(par_spectrum, par_wavelength)
    ppfd = area_under_curve * 0.2  # Fator de convers√£o simulado
    
    return ppfd

# Fun√ß√£o para calcular intensidades m√©dias por regi√£o
def calcular_intensidades_regionais(wavelength, spectrum):
    regi√µes = {
        'Azul (400-500 nm)': (400, 500),
        'Verde (500-600 nm)': (500, 600),
        'Vermelho (600-700 nm)': (600, 700),
        'Vermelho Distante (700-800 nm)': (700, 800)
    }
    
    intensidades = {}
    for nome, (inicio, fim) in regi√µes.items():
        mascara = (wavelength >= inicio) & (wavelength <= fim)
        if np.sum(mascara) > 0:
            intensidade_media = np.mean(spectrum[mascara])
            intensidades[nome] = intensidade_media
        else:
            intensidades[nome] = 0.0
    
    return intensidades

# Gerar ou usar dados congelados
if st.session_state.freeze_data and st.session_state.frozen_spectrum is not None:
    wavelength = st.session_state.frozen_spectrum[0]
    spectrum = st.session_state.frozen_spectrum[1]
    ppfd = st.session_state.frozen_ppfd
    intensidades_regiao = st.session_state.frozen_intensities
else:
    wavelength, spectrum = gerar_espectro_simulado()
    ppfd = calcular_ppfd(wavelength, spectrum)
    intensidades_regiao = calcular_intensidades_regionais(wavelength, spectrum)
    
    # Salvar estado se congelado
    if st.session_state.freeze_data:
        st.session_state.frozen_spectrum = (wavelength.copy(), spectrum.copy())
        st.session_state.frozen_ppfd = ppfd
        st.session_state.frozen_intensities = intensidades_regiao.copy()

# Layout principal
col1, col2 = st.columns([3, 1])

with col1:
    st.subheader("üìä Espectro de Luz")
    
    # Indicador de estado
    if st.session_state.freeze_data:
        st.warning("‚ö†Ô∏è Espectro congelado - Modo de visualiza√ß√£o")
    else:
        st.success("üîÑ Atualizando em tempo real")
    
    # Criar gr√°fico
    fig = go.Figure()
    
    # Adicionar espectro
    fig.add_trace(go.Scatter(
        x=wavelength,
        y=spectrum,
        mode='lines',
        line=dict(color='royalblue', width=2),
        name='Espectro',
        hovertemplate='Comprimento: %{x:.1f} nm<br>Intensidade: %{y:.3f}<extra></extra>'
    ))
    
    # Adicionar √°reas coloridas para regi√µes do espectro
    cores_regioes = {
        'UV': ('380-400', 380, 400, 'rgba(128, 0, 128, 0.1)'),
        'Azul': ('400-500', 400, 500, 'rgba(0, 0, 255, 0.1)'),
        'Verde': ('500-600', 500, 600, 'rgba(0, 255, 0, 0.1)'),
        'Vermelho': ('600-700', 600, 700, 'rgba(255, 0, 0, 0.1)'),
        'Infravermelho': ('700-800', 700, 800, 'rgba(255, 165, 0, 0.1)')
    }
    
    for nome, (label, inicio, fim, cor) in cores_regioes.items():
        fig.add_vrect(
            x0=inicio, x1=fim,
            fillcolor=cor,
            opacity=0.2,
            line_width=0,
            annotation_text=label if nome in ['Azul', 'Verde', 'Vermelho'] else "",
            annotation_position="top left",
            annotation_font_size=10
        )
    
    # Configura√ß√µes do layout
    fig.update_layout(
        title="Espectro de Luz Completo (380-800 nm)",
        xaxis_title="Comprimento de Onda (nm)",
        yaxis_title="Intensidade Relativa (unidades arbitr√°rias)",
        height=500,
        showlegend=False,
        hovermode='x unified',
        template='plotly_white',
        margin=dict(l=50, r=50, t=80, b=50),
        xaxis=dict(
            showgrid=True,
            gridcolor='lightgray',
            gridwidth=0.5,
            range=[380, 800]
        ),
        yaxis=dict(
            showgrid=True,
            gridcolor='lightgray',
            gridwidth=0.5,
            zeroline=True,
            zerolinecolor='gray',
            zerolinewidth=1
        )
    )
    
    st.plotly_chart(fig, use_container_width=True)

with col2:
    st.subheader("üìà M√©tricas")
    
    # Card de PPFD
    metric_ppfd = ppfd
    st.metric(
        label="**PPFD**",
        value=f"{metric_ppfd:.1f}",
        delta=f"{'Est√°vel' if st.session_state.freeze_data else 'Variando'}",
        help="Densidade de Fluxo de F√≥tons Fotossint√©ticos (400-700 nm)"
    )
    st.caption("Œºmol/m¬≤/s")
    
    st.markdown("---")
    
    # Intensidades por regi√£o
    st.subheader("üîç Intensidade por Regi√£o")
    
    for regiao, intensidade in intensidades_regiao.items():
        # Determinar cor baseada na regi√£o
        if 'Azul' in regiao:
            cor = "blue"
            icon = "üîµ"
        elif 'Verde' in regiao:
            cor = "green"
            icon = "üü¢"
        elif 'Vermelho' in regiao:
            cor = "red"
            icon = "üî¥"
        else:
            cor = "orange"
            icon = "üü†"
        
        # Criar container para cada regi√£o
        with st.container():
            cols = st.columns([1, 2])
            with cols[0]:
                st.markdown(f"**{icon}**")
            with cols[1]:
                st.metric(
                    label=regiao,
                    value=f"{intensidade:.3f}",
                    label_visibility="visible"
                )
        st.progress(min(intensidade, 1.0))

# Rodap√©
st.markdown("---")
col_info1, col_info2, col_info3 = st.columns(3)

with col_info1:
    st.caption(f"üìÖ {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}")

with col_info2:
    if st.session_state.freeze_data:
        st.caption("üõë Modo: Visualiza√ß√£o congelada")
    else:
        st.caption("üîÑ Modo: Atualiza√ß√£o em tempo real")

with col_info3:
    resolu√ß√£o = len(wavelength)
    st.caption(f"üìè Resolu√ß√£o: {resolu√ß√£o} pontos")

# Instru√ß√µes
with st.expander("‚ÑπÔ∏è Sobre as m√©tricas"):
    st.markdown("""
    **PPFD (Photosynthetic Photon Flux Density):**
    - Medida da densidade de f√≥tons fotossinteticamente ativos
    - Unidade: Œºmol/m¬≤/s
    - Faixa: 400-700 nm (PAR - Radia√ß√£o Fotossinteticamente Ativa)
    
    **Intensidade por Regi√£o:**
    - **Azul (400-500 nm):** Importante para morfologia e fototropismo
    - **Verde (500-600 nm):** Penetra mais profundamente no dossel
    - **Vermelho (600-700 nm):** Alta efici√™ncia fotossint√©tica
    - **Vermelho Distante (700-800 nm):** Regula flora√ß√£o e alongamento
    
    **Nota:** Valores em unidades arbitr√°rias para simula√ß√£o.
    """)

st.markdown("---")
st.caption("Desenvolvido para an√°lise espectral em pesquisa vegetal üå±")
