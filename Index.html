<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espectr√¥metro de Luz</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000000;
            color: #ffffff;
            padding: 15px;
            line-height: 1.5;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 20px;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #1a237e, #311b92);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 8px;
            color: #64b5f6;
        }
        
        .subtitle {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 300;
        }
        
        .video-section {
            background: rgba(30, 30, 40, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .video-container {
            width: 100%;
            height: 250px;
            background: #000;
            border-radius: 10px;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
            border: 2px solid #333;
        }
        
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            display: none;
        }
        
        #placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            background: #111;
            border-radius: 10px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        button {
            flex: 1;
            min-width: 150px;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:active {
            transform: scale(0.95);
        }
        
        #startBtn {
            background: linear-gradient(135deg, #2196F3, #21CBF3);
            color: white;
        }
        
        #stopBtn {
            background: linear-gradient(135deg, #FF5252, #FF4081);
            color: white;
            display: none;
        }
        
        #flipBtn {
            background: linear-gradient(135deg, #FF9800, #FFC107);
            color: white;
            display: none;
        }
        
        .spectrum-section {
            background: rgba(30, 30, 40, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .chart-container {
            width: 100%;
            height: 280px;
            margin-bottom: 20px;
        }
        
        #spectrumCanvas {
            width: 100%;
            height: 100%;
            background: #000;
            border-radius: 10px;
            border: 1px solid #333;
        }
        
        .readings {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        .reading-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid;
        }
        
        .reading-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .reading-value {
            font-size: 24px;
            font-weight: bold;
            margin: 8px 0;
            font-family: 'Courier New', monospace;
        }
        
        .reading-unit {
            font-size: 11px;
            opacity: 0.7;
        }
        
        .red { border-left-color: #ff4444; color: #ff4444; }
        .green { border-left-color: #44ff44; color: #44ff44; }
        .blue { border-left-color: #4444ff; color: #4444ff; }
        .purple { border-left-color: #aa44ff; color: #aa44ff; }
        
        .permission-help {
            background: rgba(255, 183, 77, 0.1);
            border-left: 4px solid #FF9800;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 14px;
        }
        
        .permission-help h3 {
            color: #FF9800;
            margin-bottom: 10px;
        }
        
        .permission-help ul {
            padding-left: 20px;
        }
        
        .permission-help li {
            margin-bottom: 5px;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            border-top: 1px solid #333;
            font-size: 12px;
            color: #888;
        }
        
        @media (max-width: 480px) {
            .readings {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
            
            button {
                min-width: 100%;
            }
            
            .video-container {
                height: 200px;
            }
            
            .chart-container {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üî¨ Espectr√¥metro de Luz</h1>
            <p class="subtitle">An√°lise em tempo real - Para l√¢mpadas de cultivo</p>
        </header>
        
        <section class="video-section">
            <h2>üì∑ Captura de Luz</h2>
            <div class="video-container">
                <div id="placeholder">
                    <div style="font-size: 48px; margin-bottom: 15px;">üå±</div>
                    <h3 style="margin-bottom: 10px;">Pronto para analisar</h3>
                    <p>Aponte para uma l√¢mpada e inicie a c√¢mera</p>
                </div>
                <video id="video" autoplay playsinline muted></video>
            </div>
            
            <div class="controls">
                <button id="startBtn">
                    <span style="font-size: 20px;">‚ñ∂</span> INICIAR C√ÇMERA
                </button>
                <button id="stopBtn">
                    <span style="font-size: 20px;">‚èπ</span> PARAR C√ÇMERA
                </button>
                <button id="flipBtn">
                    <span style="font-size: 20px;">üîÑ</span> VIRAR C√ÇMERA
                </button>
            </div>
        </section>
        
        <section class="spectrum-section">
            <h2>üåà Espectro em Tempo Real</h2>
            <div class="chart-container">
                <canvas id="spectrumCanvas"></canvas>
            </div>
            
            <div class="readings">
                <div class="reading-card red">
                    <div class="reading-label">Vermelho (620-750nm)</div>
                    <div class="reading-value red" id="redValue">0</div>
                    <div class="reading-unit">Intensidade</div>
                </div>
                <div class="reading-card green">
                    <div class="reading-label">Verde (495-570nm)</div>
                    <div class="reading-value green" id="greenValue">0</div>
                    <div class="reading-unit">Intensidade</div>
                </div>
                <div class="reading-card blue">
                    <div class="reading-label">Azul (450-495nm)</div>
                    <div class="reading-value blue" id="blueValue">0</div>
                    <div class="reading-unit">Intensidade</div>
                </div>
                <div class="reading-card purple">
                    <div class="reading-label">UV Estimado (300-400nm)</div>
                    <div class="reading-value purple" id="uvValue">0</div>
                    <div class="reading-unit">Intensidade</div>
                </div>
            </div>
        </section>
        
        <div class="permission-help">
            <h3>üîì Se a c√¢mera n√£o abrir:</h3>
            <ul>
                <li>Toque em <strong>"PERMITIR"</strong> quando o navegador perguntar</li>
                <li>Se j√° negou: Atualize a p√°gina e tente novamente</li>
                <li>Ou use o Firefox para Android</li>
                <li>Ou atualize o Chrome</li>
            </ul>
        </div>
        
        <footer>
            <p>üì± Espectr√¥metro v1.0 - An√°lise cont√≠nua do espectro luminoso</p>
            <p>üå± Ideal para an√°lise de l√¢mpadas de cultivo</p>
            <p>‚ö†Ô∏è A regi√£o UV √© estimada com base na resposta do sensor</p>
        </footer>
    </div>

    <script>
        // Elementos DOM
        const video = document.getElementById('video');
        const placeholder = document.getElementById('placeholder');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const flipBtn = document.getElementById('flipBtn');
        const canvas = document.getElementById('spectrumCanvas');
        const ctx = canvas.getContext('2d');
        
        // Elementos de leitura
        const redValue = document.getElementById('redValue');
        const greenValue = document.getElementById('greenValue');
        const blueValue = document.getElementById('blueValue');
        const uvValue = document.getElementById('uvValue');
        
        // Estado
        let stream = null;
        let isCameraActive = false;
        let useFrontCamera = false;
        let animationId = null;
        
        // Configurar canvas
        canvas.width = canvas.clientWidth;
        canvas.height = 280;
        
        // 1. INICIAR C√ÇMERA (simplificado para Android)
        startBtn.addEventListener('click', async () => {
            try {
                console.log('Tentando iniciar c√¢mera...');
                
                // M√©todo SUPER SIMPLES que funciona no Android
                const constraints = {
                    video: {
                        facingMode: useFrontCamera ? 'user' : 'environment'
                    },
                    audio: false
                };
                
                // Tentar m√©todo simples
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // Conectar ao v√≠deo
                video.srcObject = stream;
                
                // Quando o v√≠deo estiver pronto
                video.onloadedmetadata = () => {
                    video.play();
                    
                    // Mostrar v√≠deo e esconder placeholder
                    video.style.display = 'block';
                    placeholder.style.display = 'none';
                    
                    // Atualizar bot√µes
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'flex';
                    flipBtn.style.display = 'flex';
                    
                    isCameraActive = true;
                    
                    console.log('C√¢mera iniciada com sucesso!');
                    
                    // Iniciar an√°lise autom√°tica
                    startContinuousAnalysis();
                };
                
            } catch (error) {
                console.error('Erro:', error);
                
                // Tentar m√©todo MAIS SIMPLES ainda
                try {
                    console.log('Tentando m√©todo alternativo...');
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: true,
                        audio: false 
                    });
                    
                    video.srcObject = stream;
                    video.onloadedmetadata = () => {
                        video.play();
                        video.style.display = 'block';
                        placeholder.style.display = 'none';
                        startBtn.style.display = 'none';
                        stopBtn.style.display = 'flex';
                        flipBtn.style.display = 'flex';
                        isCameraActive = true;
                        startContinuousAnalysis();
                    };
                    
                } catch (secondError) {
                    console.error('Segunda tentativa falhou:', secondError);
                    
                    // Mensagem amig√°vel
                    let errorMessage = '‚ùå N√£o foi poss√≠vel acessar a c√¢mera.\n\n';
                    
                    if (secondError.name === 'NotAllowedError') {
                        errorMessage += 'Voc√™ NEGOU a permiss√£o da c√¢mera.\n\n';
                        errorMessage += 'Para corrigir:\n';
                        errorMessage += '1. ATUALIZE esta p√°gina\n';
                        errorMessage += '2. Toque em "PERMITIR" quando perguntado\n';
                        errorMessage += '3. Ou v√° em Configura√ß√µes do Chrome ‚Üí Site settings ‚Üí Camera\n\n';
                        errorMessage += 'üì± Dica: Use o Firefox para Android se continuar com problemas.';
                    } else {
                        errorMessage += 'Erro: ' + secondError.message;
                    }
                    
                    alert(errorMessage);
                }
            }
        });
        
        // 2. AN√ÅLISE CONT√çNUA AUTOM√ÅTICA
        function startContinuousAnalysis() {
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            
            function analyze() {
                if (!isCameraActive) return;
                
                analyzeFrame();
                animationId = requestAnimationFrame(analyze);
            }
            
            analyze();
        }
        
        // 3. ANALISAR FRAME
        function analyzeFrame() {
            if (!isCameraActive || video.readyState !== video.HAVE_ENOUGH_DATA) return;
            
            try {
                // Criar canvas tempor√°rio
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                
                // Tamanho reduzido para performance
                tempCanvas.width = 320;
                tempCanvas.height = 240;
                
                // Desenhar frame atual
                tempCtx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);
                
                // Obter dados da imagem
                const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                const data = imageData.data;
                
                // Calcular m√©dias RGB
                let r = 0, g = 0, b = 0;
                let count = 0;
                
                // Analisar cada pixel (amostragem)
                for (let i = 0; i < data.length; i += 4) {
                    r += data[i];
                    g += data[i + 1];
                    b += data[i + 2];
                    count++;
                }
                
                // Calcular m√©dias
                const avgR = Math.round(r / count);
                const avgG = Math.round(g / count);
                const avgB = Math.round(b / count);
                
                // Calcular UV estimado
                const avgUV = Math.round((avgB * 0.6 + avgG * 0.4) * 0.5);
                
                // Atualizar valores na tela
                redValue.textContent = avgR;
                greenValue.textContent = avgG;
                blueValue.textContent = avgB;
                uvValue.textContent = avgUV;
                
                // Desenhar espectro
                drawSpectrum(avgR, avgG, avgB, avgUV);
                
            } catch (error) {
                // Ignorar erros tempor√°rios
            }
        }
        
        // 4. DESENHAR ESPECTRO
        function drawSpectrum(r, g, b, uv) {
            const width = canvas.width;
            const height = canvas.height;
            
            // Limpar canvas
            ctx.clearRect(0, 0, width, height);
            
            // Desenhar fundo com gradiente
            const gradient = ctx.createLinearGradient(0, 0, width, 0);
            gradient.addColorStop(0.0, 'rgba(128, 0, 128, 0.2)');
            gradient.addColorStop(0.2, 'rgba(0, 0, 255, 0.2)');
            gradient.addColorStop(0.4, 'rgba(0, 255, 0, 0.2)');
            gradient.addColorStop(0.6, 'rgba(255, 255, 0, 0.2)');
            gradient.addColorStop(0.8, 'rgba(255, 165, 0, 0.2)');
            gradient.addColorStop(1.0, 'rgba(255, 0, 0, 0.2)');
            
            // Fundo
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, width, height);
            
            // Barra de espectro
            ctx.fillStyle = gradient;
            ctx.fillRect(0, height - 25, width, 25);
            
            // Normalizar valores
            const maxVal = Math.max(r, g, b, uv, 1);
            const normR = r / maxVal;
            const normG = g / maxVal;
            const normB = b / maxVal;
            const normUV = uv / maxVal;
            
            // Desenhar linha do espectro
            ctx.beginPath();
            ctx.lineWidth = 3;
            ctx.strokeStyle = '#00ffff';
            
            // Gerar pontos suaves
            for (let wavelength = 300; wavelength <= 800; wavelength += 2) {
                let intensity = 0;
                
                if (wavelength < 400) {
                    intensity = normUV * Math.exp(-Math.pow(wavelength - 350, 2) / 2000);
                } else if (wavelength < 500) {
                    intensity = normB * Math.exp(-Math.pow(wavelength - 450, 2) / 1500);
                } else if (wavelength < 600) {
                    intensity = normG * Math.exp(-Math.pow(wavelength - 550, 2) / 1500);
                } else {
                    intensity = normR * Math.exp(-Math.pow(wavelength - 650, 2) / 2000);
                }
                
                const x = (wavelength - 300) / 500 * width;
                const y = height - 30 - (intensity * (height - 60));
                
                if (wavelength === 300) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            
            ctx.stroke();
            
            // Preencher √°rea abaixo
            ctx.lineTo(width, height - 30);
            ctx.lineTo(0, height - 30);
            ctx.closePath();
            
            const fillGrad = ctx.createLinearGradient(0, 0, 0, height);
            fillGrad.addColorStop(0, 'rgba(0, 255, 255, 0.2)');
            fillGrad.addColorStop(1, 'rgba(0, 255, 255, 0.0)');
            ctx.fillStyle = fillGrad;
            ctx.fill();
            
            // Eixos
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 1;
            
            // Eixo X
            ctx.beginPath();
            ctx.moveTo(0, height - 30);
            ctx.lineTo(width, height - 30);
            ctx.stroke();
            
            // R√≥tulos
            ctx.fillStyle = 'white';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('300nm', 20, height - 10);
            ctx.fillText('550nm', width / 2, height - 10);
            ctx.fillText('800nm', width - 20, height - 10);
            
            // T√≠tulo
            ctx.textAlign = 'left';
            ctx.font = 'bold 16px Arial';
            ctx.fillText('Espectro em Tempo Real', 10, 25);
        }
        
        // 5. VIRAR C√ÇMERA
        flipBtn.addEventListener('click', async () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            useFrontCamera = !useFrontCamera;
            
            // Reiniciar
            video.style.display = 'none';
            placeholder.style.display = 'flex';
            startBtn.style.display = 'flex';
            stopBtn.style.display = 'none';
            flipBtn.style.display = 'none';
            isCameraActive = false;
            
            // Redesenhar espectro vazio
            drawSpectrum(0, 0, 0, 0);
            
            // Esperar um pouco e reiniciar
            setTimeout(() => {
                startBtn.click();
            }, 500);
        });
        
        // 6. PARAR C√ÇMERA
        stopBtn.addEventListener('click', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            // Restaurar interface
            video.style.display = 'none';
            placeholder.style.display = 'flex';
            startBtn.style.display = 'flex';
            stopBtn.style.display = 'none';
            flipBtn.style.display = 'none';
            isCameraActive = false;
            
            // Redesenhar espectro vazio
            drawSpectrum(0, 0, 0, 0);
        });
        
        // 7. REDIMENSIONAMENTO
        window.addEventListener('resize', () => {
            canvas.width = canvas.clientWidth;
            if (!isCameraActive) {
                drawSpectrum(0, 0, 0, 0);
            }
        });
        
        // 8. INICIALIZA√á√ÉO
        window.addEventListener('DOMContentLoaded', () => {
            // Desenhar espectro inicial vazio
            drawSpectrum(0, 0, 0, 0);
            
            // Verificar suporte
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                startBtn.disabled = true;
                startBtn.innerHTML = '<span style="font-size: 20px;">‚ö†Ô∏è</span> NAVEGADOR N√ÉO COMPAT√çVEL';
                placeholder.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div>
                    <h3 style="margin-bottom: 10px;">Navegador n√£o suportado</h3>
                    <p>Use Chrome, Firefox ou Edge atualizado</p>
                `;
            }
        });
        
        // 9. PWA - Instala√ß√£o como app
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            
            // Mostrar sugest√£o ap√≥s 3 segundos
            setTimeout(() => {
                if (confirm('üì± Deseja instalar este aplicativo no seu celular?')) {
                    e.prompt();
                }
            }, 3000);
        });
    </script>
</body>
</html>
